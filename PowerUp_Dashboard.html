<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PowerUp Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts / Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Styles (cache-busted) -->
  <link rel="stylesheet" href="/styles/powerup.css?v=2025-08-07-1" />
</head>

<body class="dashboard">
  <div class="container">

    <!-- ── Sidebar ─────────────────────────────────────────────── -->
    <div class="sidebar" id="sidebar">
      <div class="item" id="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i><span>Menu</span>
      </div>
      <div class="item active" onclick="location.href='PowerUp_Dashboard.html'">
        <i class="fas fa-home"></i><span>Dashboard</span>
      </div>
      <div class="item" onclick="location.href='level-tracker.html'">
        <i class="fas fa-layer-group"></i><span>Level Tracker</span>
      </div>
      <div class="item" onclick="location.href='power-hours.html'">
        <i class="fas fa-clock"></i><span>Power Hours</span>
      </div>
      <div class="item" onclick="location.href='notes.html'">
        <i class="fas fa-sticky-note"></i><span>Notes</span>
      </div>
      <div class="item" onclick="location.href='squads.html'">
        <i class="fas fa-users"></i><span>Squads</span>
      </div>
    </div>

    <!-- ── Main ────────────────────────────────────────────────── -->
    <div class="main">

      <!-- Header / KPI cards -->
      <div class="header">
        <h1>PowerUp Dashboard</h1>
        <p>
          Welcome: <span id="js-header-name">Loading…</span>
          &emsp; Level: <span id="js-header-level">No Level</span>
        </p>
      </div>

      <div class="top-cards">
        <!-- Power Hours -->
        <div class="card power-card">
          <h3>Power Hours Logged</h3>
          <p id="js-ph-hours">— / —</p>
          <div class="progress-bar">
            <div id="js-ph-bar" class="progress-bar-inner" style="width:0%"></div>
          </div>
          <small id="js-ph-msg">Loading…</small>
          <!-- Optional: show goal range like “8–12 hrs” if you want -->
          <small id="js-ph-goal" class="muted" style="display:block;margin-top:4px;"></small>
        </div>

        <!-- Tokens -->
        <div class="card token-card">
          <h3>Tokens</h3>
          <div class="token-tracker">
            <i class="fas fa-coins"></i>
            <span id="js-token-total">0</span>
          </div>
          <div class="muted" style="margin-top:6px;">
            <span id="js-token-msg">—</span>
            <span class="token-month" style="margin-left:8px;">This month: <strong id="js-token-month">0</strong></span>
          </div>
        </div>
      </div>

      <!-- ── Tabs ──────────────────────────────────────────────── -->
      <div class="tab-buttons">
        <button class="tab-button active" onclick="showTab('ci')">Continuous Improvement</button>
        <button class="tab-button" onclick="showTab('safety')">Safety Concerns</button>
        <button class="tab-button" onclick="showTab('quality')">Quality Catches</button>
      </div>

      <!-- ── CI Tab ────────────────────────────────────────────── -->
      <div class="tab-panel active" id="tab-ci">
        <div class="table-header-row">
          <h3>Continuous Improvement (CI)</h3>
          <div class="table-header-controls">
            <select id="ci-filter" onchange="filterTable('ci')">
              <option value="all">All Statuses</option>
              <option value="approved">Approved</option>
              <option value="pending">Pending</option>
              <option value="denied">Denied</option>
            </select>
            <button class="add-btn">+ Add Submission</button>
            <span id="ci-count" class="row-count">0 submissions</span>
          </div>
        </div>

        <div class="table-scroll">
          <table id="ci-table"></table>
        </div>
      </div>

      <!-- ── Safety Tab ────────────────────────────────────────── -->
      <div class="tab-panel" id="tab-safety">
        <div class="table-header-row">
          <h3>Safety Concerns</h3>
          <div class="table-header-controls">
            <select id="safety-filter" onchange="filterTable('safety')">
              <option value="all">All Statuses</option>
              <option value="accepted">Accepted</option>
              <option value="pending">Pending</option>
              <option value="denied">Denied</option>
            </select>
            <button class="add-btn">+ Add Submission</button>
            <span id="safety-count" class="row-count">0 submissions</span>
          </div>
        </div>

        <div class="table-scroll">
          <table id="safety-table"></table>
        </div>
      </div>

      <!-- ── Quality Catches Tab ───────────────────────────────── -->
      <div class="tab-panel" id="tab-quality">
        <div class="table-header-row">
          <h3>Quality Catches</h3>
          <div class="table-header-controls">
            <select id="quality-filter" onchange="filterTable('quality')">
              <option value="all">All</option>
              <option value="pending">Pending</option>
              <option value="closed">Closed</option>
            </select>
            <button class="add-btn">+ Add Submission</button>
            <span id="quality-count" class="row-count">0 submissions</span>
          </div>
        </div>

        <div class="table-scroll">
          <table id="quality-table"></table>
        </div>
      </div>

    </div><!-- /main -->
  </div><!-- /container -->

  <!-- ── Inline helpers ───────────────────────────────────────── -->
  <script>
    // Sidebar toggle
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('sidebar-toggle');
      const bar = document.getElementById('sidebar');
      if (btn && bar) {
        btn.addEventListener('click', () => {
          bar.classList.toggle('expanded');
        });
      }
    });

    // Global so inline onclick can call it
    window.toggleSidebar = function () {
      document.getElementById('sidebar').classList.toggle('expanded');
    };

    // Tabs / filtering / sorting (unchanged)
    window.showTab = function (id) {
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      document.getElementById(`tab-${id}`)?.classList.add('active');
      const btn =
        (window.event && window.event.currentTarget) ||
        document.querySelector(`.tab-buttons .tab-button[onclick*="'${id}'"]`);
      if (btn) btn.classList.add('active');
      filterTable(id);
      if (currentSort.tabId === id) sortTable(id, currentSort.colIndex);
    };

    const visibleCount = { ci: Infinity, safety: Infinity, quality: Infinity };
    let currentSort = { tabId: null, colIndex: null, asc: true };

    window.filterTable = function (t) {
      const rows = [...document.querySelectorAll(`#${t}-table tbody tr`)];
      const filter = (document.getElementById(`${t}-filter`) || {}).value?.toLowerCase() || 'all';
      let count = 0;
      rows.forEach(r => {
        const show = (filter === 'all' || r.innerText.toLowerCase().includes(filter));
        r.style.display = show ? '' : 'none';
        if (show) count++;
      });
      const counter = document.getElementById(`${t}-count`);
      if (counter) counter.textContent = `${count} submission${count !== 1 ? 's' : ''}`;
    };

    window.sortTable = function (t, i) {
      const tbody = document.querySelector(`#${t}-table tbody`);
      if (!tbody) return;
      const rows = [...tbody.rows].filter(r => r.style.display !== 'none');
      const numeric = rows.every(r => !isNaN(r.cells[i].innerText.replace(/[^0-9.-]/g, '')));
      const asc = (currentSort.tabId === t && currentSort.colIndex === i) ? !currentSort.asc : true;
      rows.sort((a, b) => {
        const A = numeric ? parseFloat(a.cells[i].innerText) : a.cells[i].innerText;
        const B = numeric ? parseFloat(b.cells[i].innerText) : b.cells[i].innerText;
        return asc ? (A > B ? 1 : -1) : (A < B ? 1 : -1);
      }).forEach(r => tbody.appendChild(r));
      currentSort = { tabId: t, colIndex: i, asc };
      filterTable(t);
    };
  </script>

  <!-- Existing table wiring (leave as-is) -->
  <script type="module" src="/scripts/init-dashboard.js?v=2025-08-07-1"></script>

  <!-- NEW: live widgets for header, power hours, tokens -->
  <script src="/scripts/widgets-config.js"></script>
  <script src="/scripts/widgets-live.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      if (window.PUWidgets) {
        PUWidgets.init();              // uses ?emp= or localStorage prompt
        PUWidgets.renderHeader();      // Name + Level ("PowerUp Level (Select)" or "No Level")
        PUWidgets.renderPowerHours();  // total/goal, progress width, smart message
        PUWidgets.renderTokens();      // total + this month
      }
    });
  </script>
</body>
</html>
