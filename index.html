<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PowerUp Dashboard — Login</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #0f172a;
      color: #f1f5f9;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .card {
      background: #1e293b;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(0,0,0,0.5);
      max-width: 400px;
      width: 100%;
    }
    h1 { margin-bottom: 24px; text-align: center; }
    label { display: block; margin-bottom: 6px; font-weight: 600; }
    input {
      width: 100%;
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 4px;
      border: none;
      font-size: 16px;
    }
    small { color: #94a3b8; display: block; margin-bottom: 20px; }
    button {
      width: 100%;
      padding: 12px;
      background: #38bdf8;
      color: #0f172a;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled { background: #555; cursor: not-allowed; }
    .error { color: #f87171; margin-bottom: 12px; text-align: center; }
  </style>
</head>
<body>

  <div class="card">
    <h1>PowerUp Login</h1>
    <div id="errorMsg" class="error"></div>

    <label for="empID">Employee ID</label>
    <input id="empID" autocomplete="off" placeholder="e.g., IX7992... or IKS968..." />

    <small>Enter the <strong>letters + numbers</strong> from your Position ID (e.g., "<strong>IX7992648</strong>").</small>
    <button id="loginBtn" disabled>Login</button>
  </div>

<script type="module">
  import { setSession } from 'scripts/session.js';

  const SHEET_ID  = '2195459817820036';
  const PROXY_URL = 'https://powerup-proxy.onrender.com';
  const SHEET_URL = `${PROXY_URL}/sheet/${SHEET_ID}`;

  const empInput  = document.getElementById('empID');
  const loginBtn  = document.getElementById('loginBtn');
  const errorMsg  = document.getElementById('errorMsg');

  empInput.focus();

  empInput.addEventListener('input', () => {
    loginBtn.disabled = empInput.value.trim().length < 2;
  });

  empInput.addEventListener('keypress', e => {
    if (e.key === 'Enter' && !loginBtn.disabled) handleLogin();
  });

  empInput.addEventListener('paste', () => {
    setTimeout(() => {
      empInput.value = empInput.value.trim().replace(/\s+/g, '');
      loginBtn.disabled = empInput.value.length < 2;
    }, 50);
  });

  loginBtn.addEventListener('click', handleLogin);

  async function handleLogin() {
    const empID = empInput.value.trim().toUpperCase();
    loginBtn.disabled = true;
    loginBtn.textContent = 'Logging in…';
    errorMsg.textContent = '';

    try {
      const res  = await fetch(SHEET_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const data     = await res.json();
      const pidCol   = getColumnId(data.columns, 'Position ID');
      const nameCol  = getColumnId(data.columns, 'Display Name');

      const userRow  = data.rows.find(r =>
        r.cells.some(c => c.columnId === pidCol &&
                          String(c.value).toUpperCase() === empID)
      );
      if (!userRow) throw new Error(`No match found for Employee ID “${empID}”.`);

      const displayName =
        userRow.cells.find(c => c.columnId === nameCol)?.displayValue || empID;

      /* 🔄 store via helper so header auto-updates later */
      setSession('empID',       empID);        // ⬅️  changed
      setSession('displayName', displayName);  // ⬅️  changed

      window.location.href = 'PowerUp_Dashboard.html';
    } catch (err) {
      errorMsg.textContent = err.message.includes('match')
        ? err.message
        : 'Authentication service failed.';
      loginBtn.disabled = false;
      loginBtn.textContent = 'Login';
      console.error(err);
    }
  }

  function getColumnId(columns, title) {
    return columns.find(c =>
      c.title.trim().toLowerCase() === title.toLowerCase())?.id ?? null;
  }
</script>


</body>
</html>
