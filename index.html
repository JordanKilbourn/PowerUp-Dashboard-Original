<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PowerUp Dashboard â€” Login</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/styles/powerup.css" />
</head>
<body class="login-page">
  <div class="card login-card">
    <h1>PowerUp Login</h1>
    <div id="errorMsg" class="error"></div>
    <label for="empID">Employee ID</label>
    <input id="empID" autocomplete="off" placeholder="e.g., IX7992... or IKS968..." />
    <small>Enter the <strong>letters + numbers</strong> from your Position ID (e.g., "<strong>IX7992648</strong>").</small>
    <button id="loginBtn" disabled>Login</button>
  </div>
  <script type="module">
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const { fetchSheet } = await import('./scripts/api.js');
        console.log('API module loaded, fetchSheet:', fetchSheet);

        const empInput = document.getElementById('empID');
        const loginBtn = document.getElementById('loginBtn');
        const errorMsg = document.getElementById('errorMsg');

        console.log('DOM elements:', { empInput, loginBtn, errorMsg });
        if (!empInput || !loginBtn) console.error('Missing element:', { empInput, loginBtn });

        empInput.focus();

        empInput.addEventListener('input', () => {
          const value = empInput.value.trim();
          console.log('Input value:', value);
          loginBtn.disabled = value.length < 2;
          console.log('Button disabled:', loginBtn.disabled);
        });

        empInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !loginBtn.disabled) tryLogin();
        });

        empInput.addEventListener('paste', () => {
          setTimeout(() => {
            empInput.value = empInput.value.trim().replace(/\s+/g, '');
            loginBtn.disabled = empInput.value.length < 2;
          }, 50);
        });

        loginBtn.addEventListener('click', tryLogin);

        async function tryLogin() {
          const empID = empInput.value.trim().toUpperCase();
          errorMsg.textContent = '';
          loginBtn.disabled = true;
          loginBtn.textContent = 'Logging in...';

          try {
            const data = await fetchSheet('2195459817820036');
            console.log('Login data:', data);

            const pidCol = getColumnId(data.columns, 'Position ID');
            const nameCol = getColumnId(data.columns, 'Display Name');

            const match = data.rows.find(r =>
              r.cells.some(c => c.columnId === pidCol && String(c.value).toUpperCase() === empID)
            );

            if (!match) {
              errorMsg.textContent = `No match for "${empID}".`;
              loginBtn.disabled = false;
              loginBtn.textContent = 'Login';
              return;
            }

            const dispName = match.cells.find(c => c.columnId === nameCol);
            const displayName = dispName?.displayValue || dispName?.value || empID;

            sessionStorage.setItem('empID', empID);
            sessionStorage.setItem('displayName', displayName);
            window.location.href = 'PowerUp_Dashboard.html';
          } catch (err) {
            console.error('Login error:', err);
            errorMsg.textContent = 'Error connecting to service.';
            loginBtn.disabled = false;
            loginBtn.textContent = 'Login';
          }
        }

        function getColumnId(columns, title) {
          const col = columns.find(c => c.title.trim().toLowerCase() === title.toLowerCase());
          return col ? col.id : null;
        }
      } catch (err) {
        console.error('Script error:', err);
      }
    });
  </script>
</body>
</html>
