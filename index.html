<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PowerUp Dashboard â€” Login</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/styles/powerup.css" />
</head>
<body>
  <div class="card login-card">
    <h1>PowerUp Login</h1>
    <div id="errorMsg" class="error"></div>
    <label for="empID">Employee ID</label>
    <input id="empID" autocomplete="off" placeholder="e.g., IX7992... or IKS968..." />
    <small>Enter the <strong>letters + numbers</strong> from your Position ID (e.g., "<strong>IX7992648</strong>").</small>
    <button id="loginBtn" disabled>Login</button>
  </div>
  <script type="module">
    import { fetchSheet } from './scripts/api.js';

    const sheetUrl = 'https://powerup-proxy.onrender.com/sheet/2195459817820036';

    const empInput = document.getElementById('empID');
    const loginBtn = document.getElementById('loginBtn');
    const errorMsg = document.getElementById('errorMsg');

    window.onload = () => empInput.focus();

    empInput.addEventListener('input', () => {
      loginBtn.disabled = empInput.value.trim().length < 2;
    });

    empInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !loginBtn.disabled) tryLogin();
    });

    empInput.addEventListener('paste', () => {
      setTimeout(() => {
        empInput.value = empInput.value.trim().replace(/\s+/g, '');
        loginBtn.disabled = empInput.value.length < 2;
      }, 50);
    });

    loginBtn.addEventListener('click', tryLogin);

    async function tryLogin() {
      const empID = empInput.value.trim().toUpperCase();
      if (!/^[A-Z]{2}\d+$/.test(empID)) {
        errorMsg.textContent = 'Invalid Employee ID format (e.g., IX7992).';
        loginBtn.disabled = false;
        loginBtn.textContent = 'Login';
        return;
      }

      errorMsg.textContent = '';
      loginBtn.disabled = true;
      loginBtn.textContent = 'Logging in...';

      try {
        const data = await fetchSheet(sheetUrl.replace('https://powerup-proxy.onrender.com/sheet/', ''));

        const pidCol = getColumnId(data.columns, 'Position ID');
        const nameCol = getColumnId(data.columns, 'Display Name');

        const match = data.rows.find(r =>
          r.cells.some(c => c.columnId === pidCol && String(c.value).toUpperCase() === empID)
        );

        if (!match) {
          errorMsg.textContent = `No match found for Employee ID "${empID}".`;
          loginBtn.disabled = false;
          loginBtn.textContent = 'Login';
          return;
        }

        const dispName = match.cells.find(c => c.columnId === nameCol);
        const displayName = dispName?.displayValue || dispName?.value || empID;

        sessionStorage.setItem('empID', empID);
        sessionStorage.setItem('displayName', displayName);
        window.location.href = 'PowerUp_Dashboard.html';
      } catch (err) {
        console.error(err);
        errorMsg.textContent = 'Error connecting to authentication service.';
        loginBtn.disabled = false;
        loginBtn.textContent = 'Login';
      }
    }

    function getColumnId(columns, title) {
      const col = columns.find(c => c.title.trim().toLowerCase() === title.toLowerCase());
      return col ? col.id : null;
    }
  </script>
</body>
</html>
