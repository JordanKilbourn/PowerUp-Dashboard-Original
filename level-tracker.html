<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Level Tracker | PowerUp Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="/styles/powerup.css">
</head>
<body>

  <!-- Modular Includes -->
  <div id="sidebar"></div>
  <div id="header"></div>

  <!-- Page Content -->
  <div class="container">
    <h2><i class="fas fa-chart-line"></i> Monthly Level Tracker</h2>

    <table class="level-table">
      <thead>
        <tr>
          <th>Month Key</th>
          <th>CI Submissions</th>
          <th>Safety Submissions</th>
          <th>Quality Submissions</th>
          <th>Total Submissions</th>
          <th>Power Hours Logged</th>
          <th>Meets L1</th>
          <th>Meets L2</th>
          <th>Meets L3</th>
          <th>Level</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="10">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Include Loader -->
  <script src="/scripts/include.js"></script>

  <script>
    // Load components then run tracker logic
    loadComponents().then(() => {
      const empID = sessionStorage.getItem('empID');
      const displayName = sessionStorage.getItem('displayName') || 'User';
      if (!empID) {
        alert('Please log in first.');
        window.location.href = 'index.html';
        return;
      }

      const sheetId = '8346763116105604';
      const proxyUrl = `https://powerup-proxy.onrender.com/sheet/${sheetId}`;
      const tbody = document.querySelector('.level-table tbody');

      fetch(proxyUrl)
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return res.json();
        })
        .then(sheet => {
          const colMap = {};
          sheet.columns.forEach(c => colMap[c.title.trim().toLowerCase()] = c.id);

          const get = (r, title) => {
            const cell = r.cells.find(x => x.columnId === colMap[title.toLowerCase()]);
            return cell ? (cell.displayValue ?? cell.value ?? '') : '';
          };

          let rows = sheet.rows.filter(r =>
            get(r, 'Employee ID').toUpperCase() === empID
          );

          rows.sort((a, b) =>
            new Date(get(b, 'Month Key')) - new Date(get(a, 'Month Key'))
          );

          if (rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10">No records found for this employee.</td></tr>';
            return;
          }

          // Set header info (if elements exist)
          const userEl = document.getElementById('userGreeting');
          const levelEl = document.getElementById('userLevel');
          const monthEl = document.getElementById('currentMonth');

          if (userEl) userEl.textContent = displayName;
          if (levelEl) levelEl.textContent = get(rows[0], 'Level') || 'N/A';

          const monthKey = get(rows[0], 'Month Key');
          if (monthEl) {
            monthEl.textContent = monthKey
              ? new Date(monthKey).toLocaleString('default', { month: 'long', year: 'numeric' })
              : 'Unknown';
          }

          // Render table rows
          tbody.innerHTML = '';
          rows.forEach(r => {
            const tr = document.createElement('tr');
            const values = [
              get(r, 'Month Key'),
              get(r, 'CI Submissions'),
              get(r, 'Safety Submissions'),
              get(r, 'Quality Submissions'),
              get(r, 'Total Submissions'),
              get(r, 'Power Hours Logged'),
              get(r, 'Meets L1') === true ? '✓' : '✗',
              get(r, 'Meets L2') === true ? '✓' : '✗',
              get(r, 'Meets L3') === true ? '✓' : '✗',
              get(r, 'Level')
            ];

            values.forEach((val, i) => {
              const td = document.createElement('td');
              td.textContent = val;
              td.title = val;
              if ([6, 7, 8].includes(i)) {
                td.className = val === '✓' ? 'checkmark' : 'cross';
              }
              tr.appendChild(td);
            });

            tbody.appendChild(tr);
          });
        })
        .catch(err => {
          console.error("Failed to load level data:", err);
          tbody.innerHTML = '<tr><td colspan="10">Unable to load data.</td></tr>';
        });
    });
  </script>
</body>
</html>
